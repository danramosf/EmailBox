<!DOCTYPE html>
<html>
<head>
  <title>README.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules\\graphql-deduplicator\\README.md";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#graphql-deduplicator">graphql-deduplicator</a>
      </div>

      <div class="heading h2">
        <a href="#client-support">Client support</a>
      </div>

      <div class="heading h2">
        <a href="#how-does-it-work">How does it work?</a>
      </div>

      <div class="heading h2">
        <a href="#motivation">Motivation</a>
      </div>

      <div class="heading h2">
        <a href="#real-life-example">Real-life example</a>
      </div>

      <div class="heading h2">
        <a href="#usage">Usage</a>
      </div>

      <div class="heading h3">
        <a href="#server-side">Server-side</a>
      </div>

      <div class="heading h3">
        <a href="#client-side">Client-side</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="docs markdown"><div class="pilwrap" id="graphql-deduplicator">
  <h1>
    <a href="#graphql-deduplicator" name="graphql-deduplicator" class="pilcrow"></a>
graphql-deduplicator
  </h1>
</div>
<p><a href="https://travis-ci.org/gajus/graphql-deduplicator"><img src="http://img.shields.io/travis/gajus/graphql-deduplicator/master.svg?style=flat-square" alt="Travis build status"></a>
<a href="https://github.com/gajus/graphql-deduplicator"><img src="https://img.shields.io/coveralls/gajus/graphql-deduplicator.svg?style=flat-square" alt="Coveralls"></a>
<a href="https://www.npmjs.org/package/graphql-deduplicator"><img src="http://img.shields.io/npm/v/graphql-deduplicator.svg?style=flat-square" alt="NPM version"></a>
<a href="https://github.com/gajus/canonical"><img src="https://img.shields.io/badge/code%20style-canonical-blue.svg?style=flat-square" alt="Canonical Code Style"></a></p>
<p>A GraphQL response deduplicator.</p>
<p>Removes duplicate entities from the GraphQL response.</p>
<ul>
<li><a href="#client-support.html">Client support</a></li>
<li><a href="#how-does-it-work.html">How does it work?</a></li>
<li><a href="#motivation.html">Motivation</a></li>
<li><a href="#real-life-example.html">Real-life example</a></li>
<li><a href="#usage.html">Usage</a>
<ul>
<li><a href="#server-side.html">Server-side</a></li>
<li><a href="#client-side.html">Client-side</a></li>
</ul>
</li>
</ul>
<div class="pilwrap" id="client-support">
  <h2>
    <a href="#client-support" name="client-support" class="pilcrow"></a>
Client support
  </h2>
</div>
<p><code>graphql-deduplicator</code> has been tested with <a href="https://github.com/apollographql/apollo-client"><code>apollo-client</code></a>.</p>
<p>However, it should work with any GraphQL client that automatically appends <code>__typename</code> and <code>id</code> fields for every resource. If your client automatically does not request <code>__typename</code> and <code>id</code> fields, these fields can be specified in your GraphQL query.</p>
<div class="pilwrap" id="how-does-it-work">
  <h2>
    <a href="#how-does-it-work" name="how-does-it-work" class="pilcrow"></a>
How does it work?
  </h2>
</div>
<p><code>apollo-client</code> uses <code>__typename</code> and an <code>id</code> values to construct a resource identifier. The resource identifier is used to <a href="http://dev.apollodata.com/core/how-it-works.html#normalize">normalize data</a>. As a result, when GraphQL API response contains a resource with a repeating identifier, the <code>apollo-client</code> is going to read only the first instance of the resource and ignore duplicate entities. <code>graphql-deduplicator</code> strips body (fields other than <code>__datatype</code> and <code>id</code>) from all the duplicate entities.</p>
<div class="pilwrap" id="motivation">
  <h2>
    <a href="#motivation" name="motivation" class="pilcrow"></a>
Motivation
  </h2>
</div>
<p><code>graphql-deduplicator</code> is designed to reduce the GraphQL response size by removing body of duplicate entities. This allows to make queries that return large result sets of repeated data without worrying about the cost of the response body size, time it takes to parse the response or the memory the reconstructed object will consume.</p>
<div class="pilwrap" id="real-life-example">
  <h2>
    <a href="#real-life-example" name="real-life-example" class="pilcrow"></a>
Real-life example
  </h2>
</div>
<p>Consider the following schema:</p>
<pre><code class="graphql">interface Node {
  id: ID!
}

type Movie implements Node {
  id: ID!
  name: String!
  synopsis: String!
}

type Event implements Node {
  id: ID!
  movie: Movie!
  # YYYY-MM-DD
  date: String!
  # HH:mm
  time: String!
}

type Query {
  events (
    date: String
  ): [Event!]!
}

</code></pre>
<p>Using this schema, you can query events for a particular date, e.g.</p>
<pre><code class="graphql">{
  events (date: &quot;2017-05-19&quot;) {
    __typename
    id
    date
    time
    movie {
      __typename
      id
      name
      synopsis
    }
  }
}

</code></pre>
<blockquote>
<p>Note: If you are using <code>apollo-client</code>, then you do not need to include <code>__typename</code> when constructing the query. <code>apollo-client</code> will do this for you.</p>
</blockquote>
<p>The result of the above query will contain a lot of duplicate information.</p>
<pre><code class="json">{
  <span class="hljs-attr">"data"</span>: {
    <span class="hljs-attr">"events"</span>: [
      {
        <span class="hljs-attr">"__typename"</span>: <span class="hljs-string">"Event"</span>,
        <span class="hljs-attr">"id"</span>: <span class="hljs-string">"1669971"</span>,
        <span class="hljs-attr">"date"</span>: <span class="hljs-string">"2017-05-19"</span>,
        <span class="hljs-attr">"time"</span>: <span class="hljs-string">"17:25"</span>,
        <span class="hljs-attr">"movie"</span>: {
          <span class="hljs-attr">"__typename"</span>: <span class="hljs-string">"Movie"</span>,
          <span class="hljs-attr">"id"</span>: <span class="hljs-string">"1198359"</span>,
          <span class="hljs-attr">"name"</span>: <span class="hljs-string">"King Arthur: Legend of the Sword"</span>,
          <span class="hljs-attr">"synopsis"</span>: <span class="hljs-string">"When the child Arthur’s father is murdered, Vortigern, Arthur’s uncle, seizes the crown. Robbed of his birthright and with no idea who he truly is, Arthur comes up the hard way in the back alleys of the city. But once he pulls the sword Excalibur from the stone, his life is turned upside down and he is forced to acknowledge his true legacy... whether he likes it or not."</span>
        }
      },
      {
        <span class="hljs-attr">"__typename"</span>: <span class="hljs-string">"Event"</span>,
        <span class="hljs-attr">"id"</span>: <span class="hljs-string">"1669972"</span>,
        <span class="hljs-attr">"date"</span>: <span class="hljs-string">"2017-05-19"</span>,
        <span class="hljs-attr">"time"</span>: <span class="hljs-string">"20:30"</span>,
        <span class="hljs-attr">"movie"</span>: {
          <span class="hljs-attr">"__typename"</span>: <span class="hljs-string">"Movie"</span>,
          <span class="hljs-attr">"id"</span>: <span class="hljs-string">"1198359"</span>,
          <span class="hljs-attr">"name"</span>: <span class="hljs-string">"King Arthur: Legend of the Sword"</span>,
          <span class="hljs-attr">"synopsis"</span>: <span class="hljs-string">"When the child Arthur’s father is murdered, Vortigern, Arthur’s uncle, seizes the crown. Robbed of his birthright and with no idea who he truly is, Arthur comes up the hard way in the back alleys of the city. But once he pulls the sword Excalibur from the stone, his life is turned upside down and he is forced to acknowledge his true legacy... whether he likes it or not."</span>
        }
      },
      // ...
    ]
  }
}

</code></pre>
<p>I've run into this situation when building https://gotocinema.com. A query retrieving 300 events (movie screening event) produced a response of 1.5MB. When gziped, that number dropped to 100KB. However, the problem is that upon receiving the response, the browser needs to parse the entire JSON document. Parsing 1.5MB JSON string is (a) time consuming and (b) memory expensive.</p>
<p>The good news is that we do not need to return body of duplicate records (see <a href="#how-does-it-work.html">How does it work?</a>). For all duplicate records we only need to return <code>__typename</code> and <code>id</code>. This information is enough for <code>apollo-client</code> to identify the resource as duplicate and skip it. In case when a response includes large and often repeated fragments, this will reduce the response size 10x, 100x or more times.</p>
<p>In case of the earlier example, the response becomes:</p>
<pre><code class="json">{
  <span class="hljs-attr">"data"</span>: {
    <span class="hljs-attr">"events"</span>: [
      {
        <span class="hljs-attr">"__typename"</span>: <span class="hljs-string">"Event"</span>,
        <span class="hljs-attr">"id"</span>: <span class="hljs-string">"1669971"</span>,
        <span class="hljs-attr">"date"</span>: <span class="hljs-string">"2017-05-19"</span>,
        <span class="hljs-attr">"time"</span>: <span class="hljs-string">"17:25"</span>,
        <span class="hljs-attr">"movie"</span>: {
          <span class="hljs-attr">"__typename"</span>: <span class="hljs-string">"Movie"</span>,
          <span class="hljs-attr">"id"</span>: <span class="hljs-string">"1198359"</span>,
          <span class="hljs-attr">"name"</span>: <span class="hljs-string">"King Arthur: Legend of the Sword"</span>,
          <span class="hljs-attr">"synopsis"</span>: <span class="hljs-string">"When the child Arthur’s father is murdered, Vortigern, Arthur’s uncle, seizes the crown. Robbed of his birthright and with no idea who he truly is, Arthur comes up the hard way in the back alleys of the city. But once he pulls the sword Excalibur from the stone, his life is turned upside down and he is forced to acknowledge his true legacy... whether he likes it or not."</span>
        }
      },
      {
        <span class="hljs-attr">"__typename"</span>: <span class="hljs-string">"Event"</span>,
        <span class="hljs-attr">"id"</span>: <span class="hljs-string">"1669972"</span>,
        <span class="hljs-attr">"date"</span>: <span class="hljs-string">"2017-05-19"</span>,
        <span class="hljs-attr">"time"</span>: <span class="hljs-string">"20:30"</span>,
        <span class="hljs-attr">"movie"</span>: {
          <span class="hljs-attr">"__typename"</span>: <span class="hljs-string">"Movie"</span>,
          <span class="hljs-attr">"id"</span>: <span class="hljs-string">"1198359"</span>
        }
      },
      // ...
    ]
  }
}

</code></pre>
<p>The <code>synopsis</code> and <code>name</code> fields have been removed from the duplicate <code>Movie</code> entity.</p>
<div class="pilwrap" id="usage">
  <h2>
    <a href="#usage" name="usage" class="pilcrow"></a>
Usage
  </h2>
</div>
<div class="pilwrap" id="server-side">
  <h3>
    <a href="#server-side" name="server-side" class="pilcrow"></a>
Server-side
  </h3>
</div>
<p>You need to format the final result of the query. If you are using <a href="https://github.com/apollographql/graphql-server"><code>graphql-server</code></a>, configure <code>formatResponse</code>, e.g.</p>
<pre><code class="js"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> {
  graphqlExpress
} <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-server-express'</span>;
<span class="hljs-keyword">import</span> {
  deflate
} <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-deduplicator'</span>;

<span class="hljs-keyword">const</span> SERVICE_PORT = <span class="hljs-number">3000</span>;

<span class="hljs-keyword">const</span> app = express();

app.use(<span class="hljs-string">'/graphql'</span>, graphqlExpress(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">formatResponse</span>: <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (response.data &amp;&amp; !response.data.__schema) {
        <span class="hljs-keyword">return</span> deflate(response.data);
      }

      <span class="hljs-keyword">return</span> response;
    }
  };
}));

app.listen(SERVICE_PORT);

</code></pre>
<div class="pilwrap" id="client-side">
  <h3>
    <a href="#client-side" name="client-side" class="pilcrow"></a>
Client-side
  </h3>
</div>
<p>You need to modify the server response before it is processed by the GraphQL client. If you are using <a href="https://github.com/apollographql/apollo-client"><code>apollo-client</code></a>, use <a href="https://www.apollographql.com/docs/react/reference/index.html#types"><code>link</code></a> configuration to setup an <a href="https://www.apollographql.com/docs/react/basics/network-layer.html#linkAfterware">afterware</a>, e.g.</p>
<pre><code class="js"><span class="hljs-comment">// @flow</span>

<span class="hljs-keyword">import</span> {
  ApolloClient
} <span class="hljs-keyword">from</span> <span class="hljs-string">'apollo-client'</span>;
<span class="hljs-keyword">import</span> {
  ApolloLink,
  concat
} <span class="hljs-keyword">from</span> <span class="hljs-string">'apollo-link'</span>;
<span class="hljs-keyword">import</span> {
  HttpLink
} <span class="hljs-keyword">from</span> <span class="hljs-string">'apollo-link-http'</span>;
<span class="hljs-keyword">import</span> {
  inflate
} <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-deduplicator'</span>;

<span class="hljs-keyword">const</span> httpLink = <span class="hljs-keyword">new</span> HttpLink({
  <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>,
  <span class="hljs-attr">uri</span>: <span class="hljs-string">'/api'</span>
});

<span class="hljs-keyword">const</span> inflateLink = <span class="hljs-keyword">new</span> ApolloLink(<span class="hljs-function">(<span class="hljs-params">operation, forward</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> forward(operation)
    .map(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> inflate(response);
    });
});

<span class="hljs-keyword">const</span> apolloClient = <span class="hljs-keyword">new</span> ApolloClient({
  <span class="hljs-attr">link</span>: concat(inflateLink, httpLink)
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> apolloClient;

</code></pre>
</div>
  </div>
</body>
</html>
