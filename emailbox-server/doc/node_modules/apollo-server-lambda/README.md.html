<!DOCTYPE html>
<html>
<head>
  <title>README.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules\\apollo-server-lambda\\README.md";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h2">
        <a href="#title-lambda-description-setting-up-apollo-server-with-lambda">title: Lambda
description: Setting up Apollo Server with Lambda</a>
      </div>

      <div class="heading h2">
        <a href="#deploying-with-aws-serverless-application-model-sam">Deploying with AWS Serverless Application Model (SAM)</a>
      </div>

      <div class="heading h4">
        <a href="#1.write-the-api-handlers">1. Write the API handlers</a>
      </div>

      <div class="heading h4">
        <a href="#2.create-an-s3-bucket">2. Create an S3 bucket</a>
      </div>

      <div class="heading h4">
        <a href="#3.create-the-template">3. Create the Template</a>
      </div>

      <div class="heading h4">
        <a href="#4.package-source-code-and-dependencies">4. Package source code and dependencies</a>
      </div>

      <div class="heading h4">
        <a href="#5.deploy-the-api">5. Deploy the API</a>
      </div>

      <div class="heading h2">
        <a href="#getting-request-info">Getting request info</a>
      </div>

      <div class="heading h2">
        <a href="#modifying-the-lambda-response-enable-cors">Modifying the Lambda Response (Enable CORS)</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="docs markdown"><hr>
<div class="pilwrap" id="title-lambda-description-setting-up-apollo-server-with-lambda">
  <h2>
    <a href="#title-lambda-description-setting-up-apollo-server-with-lambda" name="title-lambda-description-setting-up-apollo-server-with-lambda" class="pilcrow"></a>
title: Lambda
description: Setting up Apollo Server with Lambda
  </h2>
</div>
<p><a href="https://badge.fury.io/js/apollo-server-core"><img src="https://badge.fury.io/js/apollo-server-core.svg" alt="npm version"></a> <a href="https://circleci.com/gh/apollographql/apollo-cache-control-js"><img src="https://circleci.com/gh/apollographql/apollo-cache-control-js.svg?style=svg" alt="Build Status"></a> <a href="https://coveralls.io/github/apollographql/apollo-server?branch=master"><img src="https://coveralls.io/repos/github/apollographql/apollo-server/badge.svg?branch=master" alt="Coverage Status"></a> <a href="https://www.apollographql.com/#slack"><img src="https://img.shields.io/badge/slack-join-orange.svg" alt="Get on Slack"></a></p>
<p>This is the AWS Lambda integration for the Apollo community GraphQL Server. <a href="https://www.apollographql.com/docs/apollo-server/">Read the docs.</a> <a href="https://github.com/apollographql/apollo-server/blob/master/CHANGELOG.md">Read the CHANGELOG.</a></p>
<pre><code class="sh">npm install apollo-server-lambda
</code></pre>
<p><div class="pilwrap" id="deploying-with-aws-serverless-application-model-sam">
  <h2 id="deploying" title="Deploying with SAM">
    <a href="#deploying-with-aws-serverless-application-model-sam" name="deploying-with-aws-serverless-application-model-sam" class="pilcrow"></a>
Deploying with AWS Serverless Application Model (SAM)
  </h2>
</div></p>
<p>To deploy the AWS Lambda function we must create a Cloudformation Template and a S3 bucket to store the artifact (zip of source code) and template. We will use the <a href="https://aws.amazon.com/cli/">AWS Command Line Interface</a>.</p>
<div class="pilwrap" id="1.write-the-api-handlers">
  <h4>
    <a href="#1.write-the-api-handlers" name="1.write-the-api-handlers" class="pilcrow"></a>
1. Write the API handlers
  </h4>
</div>
<pre><code class="js"><span class="hljs-comment">// graphql.js</span>
<span class="hljs-keyword">var</span> server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'apollo-server-lambda'</span>),
  myGraphQLSchema = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./schema'</span>);

exports.graphqlHandler = server.graphqlLambda({ <span class="hljs-attr">schema</span>: myGraphQLSchema });
exports.graphiqlHandler = server.graphiqlLambda({
  <span class="hljs-attr">endpointURL</span>: <span class="hljs-string">'/Prod/graphql'</span>,
});
</code></pre>
<div class="pilwrap" id="2.create-an-s3-bucket">
  <h4>
    <a href="#2.create-an-s3-bucket" name="2.create-an-s3-bucket" class="pilcrow"></a>
2. Create an S3 bucket
  </h4>
</div>
<p>The bucket name name must be universally unique.</p>
<pre><code class="bash">aws s3 mb s3://&lt;bucket name&gt;
</code></pre>
<div class="pilwrap" id="3.create-the-template">
  <h4>
    <a href="#3.create-the-template" name="3.create-the-template" class="pilcrow"></a>
3. Create the Template
  </h4>
</div>
<p>This will look for a file called graphql.js with two exports: <code>graphqlHandler</code> and <code>graphiqlHandler</code>. It creates two API endpoints:</p>
<ul>
<li><code>/graphql</code> (GET and POST)</li>
<li><code>/graphiql</code> (GET)</li>
</ul>
<p>In a file called <code>template.yaml</code>:</p>
<pre><code class="yaml"><span class="hljs-attr">AWSTemplateFormatVersion:</span> <span class="hljs-string">'2010-09-09'</span>
<span class="hljs-attr">Transform:</span> <span class="hljs-attr">AWS::Serverless-2016-10-31</span>
<span class="hljs-attr">Resources:</span>
<span class="hljs-attr">  GraphQL:</span>
<span class="hljs-attr">    Type:</span> <span class="hljs-attr">AWS::Serverless::Function</span>
<span class="hljs-attr">    Properties:</span>
<span class="hljs-attr">      Handler:</span> <span class="hljs-string">graphql.graphqlHandler</span>
<span class="hljs-attr">      Runtime:</span> <span class="hljs-string">nodejs6.10</span>
<span class="hljs-attr">      Events:</span>
<span class="hljs-attr">        GetRequest:</span>
<span class="hljs-attr">          Type:</span> <span class="hljs-string">Api</span>
<span class="hljs-attr">          Properties:</span>
<span class="hljs-attr">            Path:</span> <span class="hljs-string">/graphql</span>
<span class="hljs-attr">            Method:</span> <span class="hljs-string">get</span>
<span class="hljs-attr">        PostRequest:</span>
<span class="hljs-attr">          Type:</span> <span class="hljs-string">Api</span>
<span class="hljs-attr">          Properties:</span>
<span class="hljs-attr">            Path:</span> <span class="hljs-string">/graphql</span>
<span class="hljs-attr">            Method:</span> <span class="hljs-string">post</span>
<span class="hljs-attr">  GraphQLInspector:</span>
<span class="hljs-attr">    Type:</span> <span class="hljs-attr">AWS::Serverless::Function</span>
<span class="hljs-attr">    Properties:</span>
<span class="hljs-attr">      Handler:</span> <span class="hljs-string">graphql.graphiqlHandler</span>
<span class="hljs-attr">      Runtime:</span> <span class="hljs-string">nodejs6.10</span>
<span class="hljs-attr">      Events:</span>
<span class="hljs-attr">        GetRequest:</span>
<span class="hljs-attr">          Type:</span> <span class="hljs-string">Api</span>
<span class="hljs-attr">          Properties:</span>
<span class="hljs-attr">            Path:</span> <span class="hljs-string">/graphiql</span>
<span class="hljs-attr">            Method:</span> <span class="hljs-string">get</span>
</code></pre>
<div class="pilwrap" id="4.package-source-code-and-dependencies">
  <h4>
    <a href="#4.package-source-code-and-dependencies" name="4.package-source-code-and-dependencies" class="pilcrow"></a>
4. Package source code and dependencies
  </h4>
</div>
<p>This will read and transform the template, created in previous step. Package and upload the artifact to the S3 bucket and generate another template for the deployment.</p>
<pre><code class="sh">aws cloudformation package \
   --template-file template.yaml \
   --output-template-file serverless-output.yaml \
   --s3-bucket &lt;bucket-name&gt;
</code></pre>
<div class="pilwrap" id="5.deploy-the-api">
  <h4>
    <a href="#5.deploy-the-api" name="5.deploy-the-api" class="pilcrow"></a>
5. Deploy the API
  </h4>
</div>
<p>The will create the Lambda Function and API Gateway for GraphQL. We use the stack-name <code>prod</code> to mean production but any stack name can be used.</p>
<pre><code>aws cloudformation deploy \
   --template-file serverless-output.yaml \
   --stack-name prod \
   --capabilities CAPABILITY_IAM
</code></pre>
<p><div class="pilwrap" id="getting-request-info">
  <h2 id="request-info" title="Getting request info">
    <a href="#getting-request-info" name="getting-request-info" class="pilcrow"></a>
Getting request info
  </h2>
</div></p>
<p>To read information about the current request from the API Gateway event (HTTP headers, HTTP method, body, path, ...) or the current Lambda Context (Function Name, Function Version, awsRequestId, time remaning, ...) use the options function. This way they can be passed to your schema resolvers using the context option.</p>
<pre><code class="js"><span class="hljs-keyword">var</span> server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'apollo-server-lambda'</span>),
  myGraphQLSchema = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./schema'</span>);

exports.graphqlHandler = server.graphqlLambda(<span class="hljs-function">(<span class="hljs-params">event, context</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> headers = event.headers,
    functionName = context.functionName;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">schema</span>: myGraphQLSchema,
    <span class="hljs-attr">context</span>: {
      headers,
      functionName,
      event,
      context,
    },
  };
});
</code></pre>
<p><div class="pilwrap" id="modifying-the-lambda-response-enable-cors">
  <h2 id="modifying-response" title="Modifying the response">
    <a href="#modifying-the-lambda-response-enable-cors" name="modifying-the-lambda-response-enable-cors" class="pilcrow"></a>
Modifying the Lambda Response (Enable CORS)
  </h2>
</div></p>
<p>To enable CORS the response HTTP headers need to be modified. To accomplish this pass in a callback filter to the generated handler of graphqlLambda.</p>
<pre><code class="js"><span class="hljs-keyword">var</span> server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'apollo-server-lambda'</span>),
  myGraphQLSchema = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./schema'</span>);

exports.graphqlHandler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, context, callback</span>) </span>{
  <span class="hljs-keyword">const</span> callbackFilter = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, output</span>) </span>{
    output.headers[<span class="hljs-string">'Access-Control-Allow-Origin'</span>] = <span class="hljs-string">'*'</span>;
    callback(error, output);
  };
  <span class="hljs-keyword">const</span> handler = server.graphqlLambda({ <span class="hljs-attr">schema</span>: myGraphQLSchema });

  <span class="hljs-keyword">return</span> handler(event, context, callbackFilter);
};
</code></pre>
<p>To enable CORS response for requests with credentials (cookies, http authentication) the allow origin header must equal the request origin and the allow credential header must be set to true.</p>
<pre><code class="js"><span class="hljs-keyword">const</span> CORS_ORIGIN = <span class="hljs-string">'https://example.com'</span>;

<span class="hljs-keyword">var</span> server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'apollo-server-lambda'</span>),
  myGraphQLSchema = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./schema'</span>);

exports.graphqlHandler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, context, callback</span>) </span>{
  <span class="hljs-keyword">const</span> requestOrigin = event.headers.origin,
    callbackFilter = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, output</span>) </span>{
      <span class="hljs-keyword">if</span> (requestOrigin === CORS_ORIGIN) {
        output.headers[<span class="hljs-string">'Access-Control-Allow-Origin'</span>] = CORS_ORIGIN;
        output.headers[<span class="hljs-string">'Access-Control-Allow-Credentials'</span>] = <span class="hljs-string">'true'</span>;
      }
      callback(error, output);
    };
  <span class="hljs-keyword">const</span> handler = server.graphqlLambda({ <span class="hljs-attr">schema</span>: myGraphQLSchema });

  <span class="hljs-keyword">return</span> handler(event, context, callbackFilter);
};
</code></pre>
</div>
  </div>
</body>
</html>
