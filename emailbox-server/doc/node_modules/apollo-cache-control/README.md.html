<!DOCTYPE html>
<html>
<head>
  <title>README.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules\\apollo-cache-control\\README.md";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#apollo-cache-control-for-node.js">Apollo Cache Control (for Node.js)</a>
      </div>

      <div class="heading h2">
        <a href="#usage">Usage</a>
      </div>

      <div class="heading h3">
        <a href="#apollo-server">Apollo Server</a>
      </div>

      <div class="heading h3">
        <a href="#add-cache-hints-to-your-schema">Add cache hints to your schema</a>
      </div>

      <div class="heading h3">
        <a href="#setting-a-default-maxage">Setting a default maxAge</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="docs markdown"><div class="pilwrap" id="apollo-cache-control-for-node.js">
  <h1>
    <a href="#apollo-cache-control-for-node.js" name="apollo-cache-control-for-node.js" class="pilcrow"></a>
Apollo Cache Control (for Node.js)
  </h1>
</div>
<p>This package is used to collect and expose cache control data in the <a href="https://github.com/apollographql/apollo-cache-control">Apollo Cache Control</a> format.</p>
<p>It relies on instrumenting a GraphQL schema to collect cache control hints, and exposes cache control data for an individual request under <code>extensions</code> as part of the GraphQL response.</p>
<p>This data can be consumed by <a href="https://www.apollographql.com/engine/">Apollo Engine</a> or any other tool to inform caching and visualize the cache policies that are in effect for a particular request.</p>
<div class="pilwrap" id="usage">
  <h2>
    <a href="#usage" name="usage" class="pilcrow"></a>
Usage
  </h2>
</div>
<div class="pilwrap" id="apollo-server">
  <h3>
    <a href="#apollo-server" name="apollo-server" class="pilcrow"></a>
Apollo Server
  </h3>
</div>
<p>Apollo Server includes built-in support for Apollo Cache Control from version 1.2.0 onwards.</p>
<p>The only code change required is to add <code>tracing: true</code> and <code>cacheControl: true</code> to the options passed to the Apollo Server middleware function for your framework of choice. For example, for Express:</p>
<pre><code class="javascript">app.use(<span class="hljs-string">'/graphql'</span>, bodyParser.json(), graphqlExpress({
  schema,
  <span class="hljs-attr">context</span>: {},
  <span class="hljs-attr">tracing</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">cacheControl</span>: <span class="hljs-literal">true</span>
}));
</code></pre>
<blockquote>
<p>If you are using <code>express-graphql</code>, we recommend you switch to Apollo Server. Both <code>express-graphql</code> and Apollo Server are based on the <a href="https://github.com/graphql/graphql-js"><code>graphql-js</code></a> reference implementation, and switching should only require changing a few lines of code.</p>
</blockquote>
<div class="pilwrap" id="add-cache-hints-to-your-schema">
  <h3>
    <a href="#add-cache-hints-to-your-schema" name="add-cache-hints-to-your-schema" class="pilcrow"></a>
Add cache hints to your schema
  </h3>
</div>
<p>Cache hints can be added to your schema using directives on your types and fields. When executing your query, these hints will be added to the response and interpreted by Engine to compute a cache policy for the response. Hints on fields override hints specified on the target type.</p>
<pre><code class="graphql">type Post @cacheControl(maxAge: 240) {
  id: Int!
  title: String
  author: Author
  votes: Int @cacheControl(maxAge: 30)
  readByCurrentUser: Boolean! @cacheControl(scope: PRIVATE)
}
</code></pre>
<p>If you need to add cache hints dynamically, you can use a programmatic API from within your resolvers.</p>
<pre><code class="javascript"><span class="hljs-keyword">const</span> resolvers = {
  <span class="hljs-attr">Query</span>: {
    <span class="hljs-attr">post</span>: <span class="hljs-function">(<span class="hljs-params">_, { id }, _, { cacheControl }</span>) =&gt;</span> {
      cacheControl.setCacheHint({ <span class="hljs-attr">maxAge</span>: <span class="hljs-number">60</span> });
      <span class="hljs-keyword">return</span> find(posts, { id });
    }
  }
}
</code></pre>
<p>If you're using TypeScript, you need the following:</p>
<pre><code class="javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'apollo-cache-control'</span>;
</code></pre>
<p>If set up correctly, for this query:</p>
<pre><code class="graphql">query {
  post(id: 1) {
    title
    votes
    readByCurrentUser
  }
}
</code></pre>
<p>You should receive cache control data in the <code>extensions</code> field of your response:</p>
<pre><code class="json">"cacheControl": {
  "version": 1,
  "hints": [
    {
      "path": [
        "post"
      ],
      "maxAge": 240
    },
    {
      "path": [
        "post",
        "votes"
      ],
      "maxAge": 30
    },
    {
      "path": [
        "post",
        "readByCurrentUser"
      ],
      "scope": "PRIVATE"
    }
  ]
}
</code></pre>
<div class="pilwrap" id="setting-a-default-maxage">
  <h3>
    <a href="#setting-a-default-maxage" name="setting-a-default-maxage" class="pilcrow"></a>
Setting a default maxAge
  </h3>
</div>
<p>The power of cache hints comes from being able to set them precisely to different values on different types and fields based on your understanding of your implementation's semantics. But when getting started with Apollo Cache Control, you might just want to apply the same <code>maxAge</code> to most of your resolvers. You can specify a default max age when you set up <code>cacheControl</code> in your server. This max age will be applied to all resolvers which don't explicitly set <code>maxAge</code> via schema hints (including schema hints on the type that they return) or the programmatic API. You can override this for a particular resolver or type by setting <code>@cacheControl(maxAge: 0)</code>. For example, for Express:</p>
<pre><code class="javascript">app.use(<span class="hljs-string">'/graphql'</span>, bodyParser.json(), graphqlExpress({
  schema,
  <span class="hljs-attr">context</span>: {},
  <span class="hljs-attr">tracing</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">cacheControl</span>: {
    <span class="hljs-attr">defaultMaxAge</span>: <span class="hljs-number">5</span>,
  },
}));
</code></pre>
</div>
  </div>
</body>
</html>
