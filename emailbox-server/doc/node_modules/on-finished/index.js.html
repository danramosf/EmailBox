<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules\\on-finished\\index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<div class="dox">
<div class="summary">
<p>!
on-finished
Copyright(c) 2013 Jonathan Ong
Copyright(c) 2014 Douglas Christopher Wilson
MIT Licensed</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">
'use strict'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>Module exports.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = onFinished
<span class="hljs-built_in">module</span>.exports.isFinished = isFinished

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Module dependencies.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> first = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ee-first'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>Variables.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-comment">/* istanbul ignore next */</span>
<span class="hljs-keyword">var</span> defer = <span class="hljs-keyword">typeof</span> setImmediate === <span class="hljs-string">'function'</span>
  ? setImmediate
  : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fn</span>)</span>{ process.nextTick(fn.bind.apply(fn, <span class="hljs-built_in">arguments</span>)) }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<div class="dox">
<div class="summary">
<p>Invoke callback when the response has finished, useful for
cleaning up resources afterwards.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">msg</span>
<span class="dox_type">object</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">listener</span>
<span class="dox_type">function</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">object</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onFinished</span>(<span class="hljs-params">msg, listener</span>) </span>{
  <span class="hljs-keyword">if</span> (isFinished(msg) !== <span class="hljs-literal">false</span>) {
    defer(listener, <span class="hljs-literal">null</span>, msg)
    <span class="hljs-keyword">return</span> msg
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>attach the listener to the message</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  attachListener(msg, listener)

  <span class="hljs-keyword">return</span> msg
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<div class="dox">
<div class="summary">
<p>Determine if message is already finished.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">msg</span>
<span class="dox_type">object</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">boolean</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isFinished</span>(<span class="hljs-params">msg</span>) </span>{
  <span class="hljs-keyword">var</span> socket = msg.socket

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> msg.finished === <span class="hljs-string">'boolean'</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>OutgoingMessage</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Boolean</span>(msg.finished || (socket &amp;&amp; !socket.writable))
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> msg.complete === <span class="hljs-string">'boolean'</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>IncomingMessage</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Boolean</span>(msg.upgrade || !socket || !socket.readable || (msg.complete &amp;&amp; !msg.readable))
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>don't know</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<div class="dox">
<div class="summary">
<p>Attach a finished listener to the message.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">msg</span>
<span class="dox_type">object</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">callback</span>
<span class="dox_type">function</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">attachFinishedListener</span>(<span class="hljs-params">msg, callback</span>) </span>{
  <span class="hljs-keyword">var</span> eeMsg
  <span class="hljs-keyword">var</span> eeSocket
  <span class="hljs-keyword">var</span> finished = <span class="hljs-literal">false</span>

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onFinish</span>(<span class="hljs-params">error</span>) </span>{
    eeMsg.cancel()
    eeSocket.cancel()

    finished = <span class="hljs-literal">true</span>
    callback(error)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>finished on first message event</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  eeMsg = eeSocket = first([[msg, <span class="hljs-string">'end'</span>, <span class="hljs-string">'finish'</span>]], onFinish)

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onSocket</span>(<span class="hljs-params">socket</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>remove listener</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    msg.removeListener(<span class="hljs-string">'socket'</span>, onSocket)

    <span class="hljs-keyword">if</span> (finished) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">if</span> (eeMsg !== eeSocket) <span class="hljs-keyword">return</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>finished on first socket event</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    eeSocket = first([[socket, <span class="hljs-string">'error'</span>, <span class="hljs-string">'close'</span>]], onFinish)
  }

  <span class="hljs-keyword">if</span> (msg.socket) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>socket already assigned</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    onSocket(msg.socket)
    <span class="hljs-keyword">return</span>
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>wait for socket to be assigned</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  msg.on(<span class="hljs-string">'socket'</span>, onSocket)

  <span class="hljs-keyword">if</span> (msg.socket === <span class="hljs-literal">undefined</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>node.js 0.8 patch</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    patchAssignSocket(msg, onSocket)
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<div class="dox">
<div class="summary">
<p>Attach the listener to the message.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">msg</span>
<span class="dox_type">object</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">function</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">attachListener</span>(<span class="hljs-params">msg, listener</span>) </span>{
  <span class="hljs-keyword">var</span> attached = msg.__onFinished

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>create a private single listener with queue</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!attached || !attached.queue) {
    attached = msg.__onFinished = createListener(msg)
    attachFinishedListener(msg, attached)
  }

  attached.queue.push(listener)
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<div class="dox">
<div class="summary">
<p>Create listener on message.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">msg</span>
<span class="dox_type">object</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">function</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createListener</span>(<span class="hljs-params">msg</span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listener</span>(<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span> (msg.__onFinished === listener) msg.__onFinished = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">if</span> (!listener.queue) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">var</span> queue = listener.queue
    listener.queue = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; queue.length; i++) {
      queue[i](err, msg)
    }
  }

  listener.queue = []

  <span class="hljs-keyword">return</span> listener
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<div class="dox">
<div class="summary">
<p>Patch ServerResponse.prototype.assignSocket for node.js 0.8.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">res</span>
<span class="dox_type">ServerResponse</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">callback</span>
<span class="dox_type">function</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">patchAssignSocket</span>(<span class="hljs-params">res, callback</span>) </span>{
  <span class="hljs-keyword">var</span> assignSocket = res.assignSocket

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> assignSocket !== <span class="hljs-string">'function'</span>) <span class="hljs-keyword">return</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>res.on('socket', callback) is broken in 0.8</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  res.assignSocket = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_assignSocket</span>(<span class="hljs-params">socket</span>) </span>{
    assignSocket.call(<span class="hljs-keyword">this</span>, socket)
    callback(socket)
  }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
